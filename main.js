  // C25K Program Data
  const c25kProgram = [
    // Week 1
    {
        name: "Week 1",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then alternate 60 seconds of jogging and 90 seconds of walking for a total of 30 minutes.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then alternate 60 seconds of jogging and 90 seconds of walking for a total of 30 minutes.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then alternate 60 seconds of jogging and 90 seconds of walking for a total of 30 minutes.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 60, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 2
    {
        name: "Week 2",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then alternate 90 seconds of jogging and 2 minutes of walking for a total of 30 minutes.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 60, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then alternate 90 seconds of jogging and 2 minutes of walking for a total of 30 minutes.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 60, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then alternate 90 seconds of jogging and 2 minutes of walking for a total of 30 minutes.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 120, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 60, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 3
    {
        name: "Week 3",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then do 2 repetitions of: 90 seconds of jogging, 90 seconds of walking, 3 minutes of jogging, 3 minutes of walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then do 2 repetitions of: 90 seconds of jogging, 90 seconds of walking, 3 minutes of jogging, 3 minutes of walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then do 2 repetitions of: 90 seconds of jogging, 90 seconds of walking, 3 minutes of jogging, 3 minutes of walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 90, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 4
    {
        name: "Week 4",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then: 3 minutes of jogging, 90 seconds of walking, 5 minutes of jogging, 2.5 minutes of walking, 3 minutes of jogging, 90 seconds of walking, 5 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "walk", duration: 150, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then: 3 minutes of jogging, 90 seconds of walking, 5 minutes of jogging, 2.5 minutes of walking, 3 minutes of jogging, 90 seconds of walking, 5 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "walk", duration: 150, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then: 3 minutes of jogging, 90 seconds of walking, 5 minutes of jogging, 2.5 minutes of walking, 3 minutes of jogging, 90 seconds of walking, 5 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "walk", duration: 150, name: "Walk" },
                    { type: "run", duration: 180, name: "Run" },
                    { type: "walk", duration: 90, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 5
    {
        name: "Week 5",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then: 5 minutes of jogging, 3 minutes of walking, 5 minutes of jogging, 3 minutes of walking, 5 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then: 8 minutes of jogging, 5 minutes of walking, 8 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 480, name: "Run" },
                    { type: "walk", duration: 300, name: "Walk" },
                    { type: "run", duration: 480, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then: 20 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1200, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 6
    {
        name: "Week 6",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then: 5 minutes of jogging, 3 minutes of walking, 8 minutes of jogging, 3 minutes of walking, 5 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 480, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 300, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then: 10 minutes of jogging, 3 minutes of walking, 10 minutes of jogging.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 600, name: "Run" },
                    { type: "walk", duration: 180, name: "Walk" },
                    { type: "run", duration: 600, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then: 25 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1500, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 7
    {
        name: "Week 7",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then: 25 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1500, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then: 25 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1500, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then: 25 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1500, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 8
    {
        name: "Week 8",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then: 28 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1680, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then: 28 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1680, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then: 28 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1680, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    },
    // Week 9
    {
        name: "Week 9",
        workouts: [
            {
                name: "Workout 1",
                description: "Brisk 5-minute warmup walk. Then: 30 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1800, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 2",
                description: "Brisk 5-minute warmup walk. Then: 30 minutes of jogging with no walking.",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1800, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            },
            {
                name: "Workout 3",
                description: "Brisk 5-minute warmup walk. Then: 30 minutes of jogging with no walking. Congratulations! You've completed the C25K program!",
                schedule: [
                    { type: "warmUp", duration: 300, name: "Warm Up" },
                    { type: "run", duration: 1800, name: "Run" },
                    { type: "coolDown", duration: 300, name: "Cool Down" }
                ]
            }
        ]
    }
];

// DOM Elements
const weekSelectBtn = document.getElementById('weekSelectBtn');
const weekDropdownMenu = document.getElementById('weekDropdownMenu');
const workoutSelector = document.getElementById('workoutSelector');
const workoutTitle = document.getElementById('workoutTitle');
const workoutDescription = document.getElementById('workoutDescription');
const timerDisplay = document.getElementById('timerDisplay');
const phaseDisplay = document.getElementById('phaseDisplay');
const nextPhasePreview = document.getElementById('nextPhasePreview');
const nextPhaseName = document.getElementById('nextPhaseName');
const progressBar = document.getElementById('progressBar');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const workoutLog = document.getElementById('workoutLog');
const settingsBtn = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const notificationToggle = document.getElementById('notificationToggle');
const themeToggle = document.getElementById('themeToggle');
const countdownToggle = document.getElementById('countdownToggle');
const notification = document.getElementById('notification');
const completionModal = document.getElementById('completionModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');
const workoutRating = document.getElementById('workoutRating');
const workoutNotes = document.getElementById('workoutNotes');
const audioVisualization = document.getElementById('audioVisualization');
const keepAwakeToggle = document.getElementById('keepAwakeToggle');
const achievementModal = document.getElementById('achievementModal');
const achievementModalIcon = document.getElementById('achievementModalIcon');
const achievementModalName = document.getElementById('achievementModalName');
const achievementModalDescription = document.getElementById('achievementModalDescription');
const achievementModalClose = document.getElementById('achievementModalClose');

// App State
let selectedWeek = null;
let selectedWorkout = null;
let currentPhaseIndex = 0;
let timer = null;
let timeRemaining = 0;
let totalWorkoutTime = 0;
let elapsedTime = 0;
let isRunning = false;
let completedWorkouts = [];
let audioContext = null;
let oscillator = null;
let activeOscillators = []; // Track all active oscillators
let isTestWorkout = false;
let settings = {
    notifications: localStorage.getItem('c25k_notifications') || 'on',
    theme: localStorage.getItem('c25k_theme') || 'light',
    countdown: localStorage.getItem('c25k_countdown') || 'on',
    keepAwake: localStorage.getItem('c25k_keepAwake') || 'off'
};
let wakeLock = null;
let achievements = [];
let earnedAchievements = [];

// Define achievements
const availableAchievements = [
    {
        id: 'first_workout',
        name: 'First Step',
        icon: '🏃',
        description: 'Complete your first workout',
        checkCondition: () => completedWorkouts.length >= 1
    },
    {
        id: 'week1_complete',
        name: 'Week 1 Complete',
        icon: '1️⃣',
        description: 'Complete all workouts in Week 1',
        checkCondition: () => isWeekCompleted(0)
    },
    {
        id: 'week5_complete',
        name: 'Halfway There',
        icon: '5️⃣',
        description: 'Complete all workouts in Week 5',
        checkCondition: () => isWeekCompleted(4)
    },
    {
        id: 'program_complete',
        name: 'Graduate Runner',
        icon: '🎓',
        description: 'Complete the entire C25K program',
        checkCondition: () => isProgramCompleted()
    },
    {
        id: 'three_in_row',
        name: 'Consistency',
        icon: '📆',
        description: 'Complete 3 workouts in a row without skipping days',
        checkCondition: () => checkConsistency(3)
    },
    {
        id: 'night_owl',
        name: 'Night Owl',
        icon: '🦉',
        description: 'Complete a workout after 8 PM',
        checkCondition: (workout) => {
            if (!workout) return false;
            const workoutTime = new Date(workout.date);
            return workoutTime.getHours() >= 20;
        }
    },
    {
        id: 'early_bird',
        name: 'Early Bird',
        icon: '🐦',
        description: 'Complete a workout before 8 AM',
        checkCondition: (workout) => {
            if (!workout) return false;
            const workoutTime = new Date(workout.date);
            return workoutTime.getHours() < 8;
        }
    },
    {
        id: 'no_walking',
        name: 'Pure Runner',
        icon: '⚡',
        description: 'Complete a workout that has no walking intervals',
        checkCondition: (workout) => {
            if (!workout) return false;
            const workoutData = c25kProgram[workout.week].workouts[workout.workout];
            return !workoutData.schedule.some(phase => phase.type === 'walk');
        }
    }
];

// Test workout for quick testing (activated with Shift key)
const testWorkout = {
    name: "Test Workout",
    description: "A short test workout for development purposes.",
    schedule: [
        { type: "warmUp", duration: 10, name: "Warm Up" },
        { type: "run", duration: 10, name: "Run" },
        { type: "walk", duration: 10, name: "Walk" },
        { type: "run", duration: 10, name: "Run" },
        { type: "coolDown", duration: 10, name: "Cool Down" }
    ]
};

async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator && !wakeLock) {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
                wakeLock = null;
            });
        }
    } catch (err) {
        console.error('Wake Lock error:', err);
    }
}

function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
}

// Initialize settings from local storage or set defaults
function applySettings() {
    notificationToggle.value = settings.notifications;
    themeToggle.value = settings.theme;
    countdownToggle.value = settings.countdown;
    keepAwakeToggle.value = settings.keepAwake;

    // Apply theme
    if (settings.theme === 'dark') {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }

    // Apply wake lock if needed
    if (settings.keepAwake === 'on') {
        requestWakeLock();
    } else {
        releaseWakeLock();
    }
}

// Save settings
function saveSettings() {
    settings.notifications = notificationToggle.value;
    settings.theme = themeToggle.value;
    settings.countdown = countdownToggle.value;
    settings.keepAwake = keepAwakeToggle.value;

    localStorage.setItem('c25k_notifications', settings.notifications);
    localStorage.setItem('c25k_theme', settings.theme);
    localStorage.setItem('c25k_countdown', settings.countdown);
    localStorage.setItem('c25k_keepAwake', settings.keepAwake);

    applySettings();
    showNotification('Settings saved');
    toggleSettingsPanel();
}

// Show notification
function showNotification(message, duration = 3000) {
    notification.textContent = message;
    notification.classList.add('active');
    
    // Add achievement styling if it's an achievement notification
    if (message.includes('Achievement unlocked')) {
        notification.classList.add('achievement-notification');
    } else {
        notification.classList.remove('achievement-notification');
    }
    
    setTimeout(() => {
        notification.classList.remove('active');
        notification.classList.remove('achievement-notification');
    }, duration);
}

// Toggle settings panel
function toggleSettingsPanel() {
    settingsPanel.classList.toggle('active');
}

// Format time (convert seconds to MM:SS)
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Initialize audio
function initializeAudio() {
    try {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    } catch (e) {
        console.error('Web Audio API is not supported in this browser.');
    }
}

// Play beep sound
function playBeep(frequency, duration) {
    if (settings.notifications === 'off' || !audioContext) return;

    try {
        // Create a new oscillator for each sound
        const newOscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        newOscillator.type = 'sine';
        newOscillator.frequency.value = frequency;
        gainNode.gain.value = 0.5;

        newOscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Add to active oscillators array
        activeOscillators.push(newOscillator);
        
        // Start the oscillator
        newOscillator.start();
        
        // Set up a timer to stop and clean up this specific oscillator
        setTimeout(() => {
            try {
                newOscillator.stop();
                // Remove from active oscillators array
                const index = activeOscillators.indexOf(newOscillator);
                if (index > -1) {
                    activeOscillators.splice(index, 1);
                }
            } catch (e) {
                console.error('Error stopping oscillator:', e);
            }
        }, duration);

        // Update visualization
        updateAudioVisualization(true);
        setTimeout(() => {
            updateAudioVisualization(false);
        }, duration);
    } catch (e) {
        console.error('Error playing audio:', e);
    }
}

// Stop all active sounds
function stopAllSounds() {
    // Stop all active oscillators
    if (activeOscillators.length > 0) {
        activeOscillators.forEach(osc => {
            try {
                osc.stop();
            } catch (e) {
                // Ignore errors if oscillator was already stopped
            }
        });
        // Clear the array
        activeOscillators = [];
    }
}

// Create audio visualization bars
function createAudioVisualization() {
    audioVisualization.innerHTML = '';
    for (let i = 0; i < 10; i++) {
        const bar = document.createElement('div');
        bar.className = 'audio-bar';
        audioVisualization.appendChild(bar);
    }
}

// Update audio visualization
function updateAudioVisualization(active, amplification = 1) {
    const bars = audioVisualization.querySelectorAll('.audio-bar');
    if (active) {
        bars.forEach(bar => {
            // Amplify for achievements
            const height = Math.floor(Math.random() * 40 * amplification) + 10;
            bar.style.height = `${height}px`;
        });
    } else {
        bars.forEach(bar => {
            bar.style.height = '5px';
        });
    }
}

// Announce phase change
function announcePhaseChange(phase) {
    if (settings.notifications === 'on') {
        if (phase.type === 'warmUp') {
            playBeep(440, 200); // A4
            setTimeout(() => playBeep(523.25, 200), 250); // C5
            setTimeout(() => playBeep(659.25, 350), 500); // E5
        } else if (phase.type === 'run') {
            playBeep(659.25, 200); // E5
            setTimeout(() => playBeep(783.99, 350), 250); // G5
        } else if (phase.type === 'walk') {
            playBeep(523.25, 200); // C5
            setTimeout(() => playBeep(440, 350), 250); // A4
        } else if (phase.type === 'coolDown') {
            playBeep(659.25, 200); // E5
            setTimeout(() => playBeep(523.25, 200), 250); // C5
            setTimeout(() => playBeep(440, 350), 500); // A4
        }
        
        // Display the phase name as notification too
        showNotification(`${phase.name} phase started`);
    }
}

// Toggle week dropdown
function toggleWeekDropdown() {
    weekDropdownMenu.classList.toggle('show');
    weekSelectBtn.classList.toggle('active');
}

// Close dropdown if clicked outside
window.addEventListener('click', function(event) {
    if (!event.target.matches('.week-select-btn') && weekDropdownMenu.classList.contains('show')) {
        weekDropdownMenu.classList.remove('show');
        weekSelectBtn.classList.remove('active');
    }
});

// Generate workout selectors
function generateWorkoutSelectors() {
    // Clear previous selectors
    weekDropdownMenu.innerHTML = '';
    workoutSelector.innerHTML = '';

    // Generate week items for dropdown
    c25kProgram.forEach((week, weekIndex) => {
        const weekItem = document.createElement('div');
        weekItem.className = 'week-item';
        weekItem.textContent = week.name;
        weekItem.dataset.week = weekIndex;
        weekItem.addEventListener('click', () => {
            selectWeek(weekIndex);
            toggleWeekDropdown();
        });
        weekDropdownMenu.appendChild(weekItem);
    });
    
    // Add event listener to dropdown button
    weekSelectBtn.addEventListener('click', toggleWeekDropdown);

    // Load completed workouts from local storage
    loadCompletedWorkouts();
}

// Select a week
function selectWeek(weekIndex) {
    selectedWeek = weekIndex;
    
    // Update UI - update dropdown button text and active state in menu
    weekSelectBtn.textContent = c25kProgram[weekIndex].name;
    
    const weekItems = document.querySelectorAll('.week-item');
    weekItems.forEach(item => item.classList.remove('active'));
    weekItems[weekIndex].classList.add('active');

    // Generate workout buttons for selected week
    workoutSelector.innerHTML = '';
    c25kProgram[weekIndex].workouts.forEach((workout, workoutIndex) => {
        const workoutBtn = document.createElement('button');
        workoutBtn.className = 'workout-btn';
        workoutBtn.textContent = workout.name;
        workoutBtn.dataset.workout = workoutIndex;
        workoutBtn.addEventListener('click', (e) => selectWorkout(workoutIndex, e));
        
        // Check if workout is completed
        if (isWorkoutCompleted(weekIndex, workoutIndex)) {
            workoutBtn.classList.add('completed');
        }
        
        workoutSelector.appendChild(workoutBtn);
    });

    // Reset selected workout
    selectedWorkout = null;
    updateWorkoutInfo();
    
    // Hide the mark as completed button when no workout is selected
    document.getElementById('markCompletedBtn').style.display = 'none';
}

// Select a workout
function selectWorkout(workoutIndex, event) {
    // Check if shift key was pressed
    isTestWorkout = event && event.shiftKey;
    selectedWorkout = workoutIndex;
    
    // Update UI
    const workoutBtns = document.querySelectorAll('.workout-btn');
    workoutBtns.forEach(btn => btn.classList.remove('active'));
    workoutBtns[workoutIndex].classList.add('active');

    // Show mark as completed button if workout is not completed yet
    const markCompletedBtn = document.getElementById('markCompletedBtn');
    if (isWorkoutCompleted(selectedWeek, selectedWorkout)) {
        markCompletedBtn.style.display = 'none';
    } else {
        markCompletedBtn.style.display = 'block';
    }

    updateWorkoutInfo();
    resetWorkout();
    
    // Show notification if test workout is selected
    if (isTestWorkout) {
        showNotification('Test workout activated! (50 seconds total)');
    }
}

// Update workout information display
function updateWorkoutInfo() {
    if (selectedWeek !== null && selectedWorkout !== null) {
        // Use test workout if shift was pressed, otherwise use selected workout
        let workout;
        let title;
        
        if (isTestWorkout) {
            workout = testWorkout;
            title = `TEST MODE: ${testWorkout.name}`;
        } else {
            workout = c25kProgram[selectedWeek].workouts[selectedWorkout];
            title = `${c25kProgram[selectedWeek].name} - ${workout.name}`;
        }
        
        workoutTitle.textContent = title;
        workoutDescription.textContent = workout.description;
        
        // Calculate total workout time
        totalWorkoutTime = workout.schedule.reduce((total, phase) => total + phase.duration, 0);
    } else {
        workoutTitle.textContent = 'Select a Workout';
        workoutDescription.textContent = 'Choose a week and workout to begin your C25K training program.';
    }
}

// Start workout
function startWorkout() {
    if (selectedWeek === null || selectedWorkout === null) {
        showNotification('Please select a workout first');
        return;
    }

    // Only start if not already running
    if (isRunning) {
        console.log('Workout already running');
        return;
    }
    
    // Clear any existing timers to prevent doubling
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
    
    // Initialize audio context (need user interaction first)
    initializeAudio();
    
    // Get current workout schedule (test workout or regular)
    const workout = isTestWorkout ? testWorkout : c25kProgram[selectedWeek].workouts[selectedWorkout];
    
    // Start first phase if not already started
    if (currentPhaseIndex === 0) {
        startPhase(workout.schedule[currentPhaseIndex]);
    }
    
    // Start or resume the main timer
    timer = setInterval(updateTimer, 1000);
    isRunning = true;
    
    // Update UI
    startBtn.disabled = true;
    stopBtn.disabled = false;
    resetBtn.disabled = true;

    // Apply wake lock if needed
    if (settings.keepAwake === 'on') {
        requestWakeLock();
    }
}

// Start a phase
function startPhase(phase) {
    // Set time remaining
    timeRemaining = phase.duration;
    
    // Update phase display
    updatePhaseDisplay(phase);
    
    // Announce phase change
    announcePhaseChange(phase);
}

// Update phase display
function updatePhaseDisplay(phase) {
    phaseDisplay.className = 'phase-display';
    phaseDisplay.classList.add(`phase-${phase.type}`);
    
    let phaseText = '';
    switch (phase.type) {
        case 'warmUp':
            phaseText = 'WARM UP';
            break;
        case 'run':
            phaseText = 'RUN';
            break;
        case 'walk':
            phaseText = 'WALK';
            break;
        case 'coolDown':
            phaseText = 'COOL DOWN';
            break;
    }
    
    // Update the current-phase div inside the phase display
    const currentPhaseElement = phaseDisplay.querySelector('.current-phase');
    if (currentPhaseElement) {
        currentPhaseElement.textContent = phaseText;
    }
}

// Show next phase preview
function showNextPhasePreview() {
    const workout = isTestWorkout ? testWorkout : c25kProgram[selectedWeek].workouts[selectedWorkout];
    const nextPhaseIndex = currentPhaseIndex + 1;
    
    // Only show if there is a next phase
    if (nextPhaseIndex < workout.schedule.length) {
        const nextPhase = workout.schedule[nextPhaseIndex];
        
        // Set the name
        nextPhaseName.textContent = nextPhase.name;
        
        // Set class based on phase type
        nextPhasePreview.className = 'next-phase-preview show';
        nextPhasePreview.classList.add(`next-phase-${nextPhase.type}`);
        
        // Show the preview
        nextPhasePreview.classList.add('show');
    } else {
        // No next phase (workout ending)
        nextPhasePreview.classList.remove('show');
    }
}

// Single continuous timer function
function updateTimer() {
    if (!isRunning) return;
    
    // Decrement the time and increment elapsed time
    timeRemaining--;
    elapsedTime++;
    
    // Update progress bar
    const progressPercentage = (elapsedTime / totalWorkoutTime) * 100;
    progressBar.style.width = `${progressPercentage}%`;
    progressBar.textContent = `${Math.round(progressPercentage)}%`;
    
    // Check if we need to transition to the next phase
    if (timeRemaining <= 0) {
        // Hide next phase preview when transitioning
        nextPhasePreview.classList.remove('show');
        nextPhasePreview.className = 'next-phase-preview';
        
        // Immediately transition to next phase
        const workout = isTestWorkout ? testWorkout : c25kProgram[selectedWeek].workouts[selectedWorkout];
        currentPhaseIndex++;
        
        // Check if workout is completed
        if (currentPhaseIndex >= workout.schedule.length) {
            completeWorkout();
            return;
        } else {
            // Move to next phase without stopping the timer
            const nextPhase = workout.schedule[currentPhaseIndex];
            timeRemaining = nextPhase.duration;
            updatePhaseDisplay(nextPhase);
            announcePhaseChange(nextPhase);
        }
    }
    
    // Update timer display
    timerDisplay.textContent = formatTime(timeRemaining);
    
    // Countdown alerts - happens on 5, 4, 3, 2, 1
    if (settings.countdown === 'on' && timeRemaining <= 5 && timeRemaining > 0) {
        // Show preview of next phase during countdown
        showNextPhasePreview();
        
        // Different tones for different transitions
        const workout = isTestWorkout ? testWorkout : c25kProgram[selectedWeek].workouts[selectedWorkout];
        const nextPhaseIndex = currentPhaseIndex + 1;
        
        // Check if there's a next phase
        if (nextPhaseIndex < workout.schedule.length) {
            const nextPhase = workout.schedule[nextPhaseIndex];
            
            // Base frequency depends on upcoming phase type
            let baseFrequency;
            if (nextPhase.type === 'run') {
                baseFrequency = 523; // Higher pitch for run
            } else if (nextPhase.type === 'walk') {
                baseFrequency = 392; // Lower pitch for walk
            } else if (nextPhase.type === 'coolDown') {
                baseFrequency = 349; // Even lower for cool down
            } else {
                baseFrequency = 440; // Default pitch
            }
            
            // Pitch increases as we get closer to zero
            const pitch = baseFrequency + ((5 - timeRemaining) * 30);
            playBeep(pitch, 100);
        } else {
            // This is the last phase - use completion tone pattern
            const pitch = 440 + ((5 - timeRemaining) * 30);
            playBeep(pitch, 100);
        }
    }
}

// Stop workout
function stopWorkout() {
    isRunning = false;
    
    // Ensure timer is properly cleared
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
    
    // Stop any ongoing sounds
    stopAllSounds();
    
    // Hide next phase preview
    nextPhasePreview.classList.remove('show');
    nextPhasePreview.className = 'next-phase-preview';
    
    // Update UI
    startBtn.disabled = false;
    stopBtn.disabled = true;
    resetBtn.disabled = false;

    // Release wake lock if not needed
    if (settings.keepAwake === 'on') {
        releaseWakeLock();
    }
}

// Reset workout
function resetWorkout() {
    stopWorkout();
    
    currentPhaseIndex = 0;
    timeRemaining = 0;
    elapsedTime = 0;
    
    // Stop any ongoing sounds
    stopAllSounds();
    
    // Update UI
    timerDisplay.textContent = '00:00';
    phaseDisplay.className = 'phase-display';
    
    // Update the current-phase div
    const currentPhaseElement = phaseDisplay.querySelector('.current-phase');
    if (currentPhaseElement) {
        currentPhaseElement.textContent = isTestWorkout ? 'TEST MODE READY' : 'Ready to start';
    }
    
    progressBar.style.width = '0%';
    progressBar.textContent = '';
    
    // Hide next phase preview
    nextPhasePreview.classList.remove('show');
    nextPhasePreview.className = 'next-phase-preview';
    nextPhaseName.textContent = '';
    
    // Update buttons
    startBtn.disabled = false;
    stopBtn.disabled = true;
    resetBtn.disabled = true;

    // Release wake lock if not needed
    if (settings.keepAwake === 'on') {
        releaseWakeLock();
    }
}

// Complete workout
function completeWorkout() {
    stopWorkout();
    
    // Ensure any lingering sounds are stopped
    stopAllSounds();
    
    // Play completion sound
    if (settings.notifications === 'on') {
        playBeep(523.25, 300); // C5
        setTimeout(() => playBeep(659.25, 300), 350); // E5
        setTimeout(() => playBeep(783.99, 300), 700); // G5
        setTimeout(() => playBeep(1046.50, 500), 1050); // C6
    }
    
    // Update UI
    phaseDisplay.className = 'phase-display';
    phaseDisplay.textContent = 'Workout Completed!';
    
    // Only show completion modal for real workouts
    if (!isTestWorkout) {
        openCompletionModal();
    } else {
        // Reset workout immediately for test mode
        resetWorkout();
        showNotification('Test workout completed!');
        isTestWorkout = false;
    }
}

// Open completion modal
function openCompletionModal() {
    completionModal.classList.add('active');
}

// Close completion modal
function closeCompletionModal() {
    completionModal.classList.remove('active');
}

// Save completed workout
function saveCompletedWorkout() {
    const workout = c25kProgram[selectedWeek].workouts[selectedWorkout];
    const weekName = c25kProgram[selectedWeek].name;
    const workoutName = workout.name;
    
    const completedWorkout = {
        date: new Date().toISOString(),
        week: selectedWeek,
        workout: selectedWorkout,
        weekName: weekName,
        workoutName: workoutName,
        rating: workoutRating.value,
        notes: workoutNotes.value
    };
    
    // Add to completed workouts
    completedWorkouts.push(completedWorkout);
    
    // Save to local storage
    saveCompletedWorkouts();
    
    // Update UI
    updateCompletedWorkoutsList();
    
    // Mark workout as completed in selector
    const workoutBtns = document.querySelectorAll('.workout-btn');
    if (workoutBtns[selectedWorkout]) {
        workoutBtns[selectedWorkout].classList.add('completed');
        workoutBtns[selectedWorkout].textContent = `${workout.name} ✓`;
    }
    
    // Close modal
    closeCompletionModal();
    
    // Reset workout
    resetWorkout();
    
    // Check for achievements
    checkAchievements(completedWorkout);
    
    // Show notification
    showNotification('Workout saved successfully!');
}

// Check if workout is completed
function isWorkoutCompleted(weekIndex, workoutIndex) {
    return completedWorkouts.some(w => w.week === weekIndex && w.workout === workoutIndex);
}

// Load completed workouts from local storage
function loadCompletedWorkouts() {
    const savedWorkouts = localStorage.getItem('c25k_completed_workouts');
    if (savedWorkouts) {
        completedWorkouts = JSON.parse(savedWorkouts);
        updateCompletedWorkoutsList();
    }
}

// Save completed workouts to local storage
function saveCompletedWorkouts() {
    localStorage.setItem('c25k_completed_workouts', JSON.stringify(completedWorkouts));
}

// Update completed workouts list
function updateCompletedWorkoutsList() {
    workoutLog.innerHTML = '';
    
    if (completedWorkouts.length === 0) {
        const emptyLog = document.createElement('li');
        emptyLog.textContent = 'No completed workouts yet';
        workoutLog.appendChild(emptyLog);
        return;
    }
    
    // Sort by date, newest first
    const sortedWorkouts = [...completedWorkouts].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedWorkouts.slice(0, 10).forEach(workout => {
        const li = document.createElement('li');
        
        const workoutInfo = document.createElement('div');
        workoutInfo.textContent = `${workout.weekName} - ${workout.workoutName}`;
        if (workout.rating) {
            const ratingText = ['Very Difficult', 'Difficult', 'Moderate', 'Easy', 'Very Easy'][parseInt(workout.rating) - 1];
            workoutInfo.textContent += ` (${ratingText})`;
        }
        
        if (workout.notes) {
            const notesElem = document.createElement('div');
            notesElem.textContent = workout.notes;
            notesElem.style.fontSize = '0.9rem';
            notesElem.style.fontStyle = 'italic';
            workoutInfo.appendChild(notesElem);
        }
        
        const dateElem = document.createElement('div');
        dateElem.className = 'log-date';
        dateElem.textContent = new Date(workout.date).toLocaleDateString();
        
        li.appendChild(workoutInfo);
        li.appendChild(dateElem);
        
        workoutLog.appendChild(li);
    });
    
    if (sortedWorkouts.length > 10) {
        const moreWorkouts = document.createElement('li');
        moreWorkouts.textContent = `+${sortedWorkouts.length - 10} more workouts`;
        moreWorkouts.style.textAlign = 'center';
        moreWorkouts.style.fontStyle = 'italic';
        workoutLog.appendChild(moreWorkouts);
    }
}

// Mark workout as completed without doing it
function markWorkoutAsCompleted() {
    if (selectedWeek === null || selectedWorkout === null) {
        showNotification('Please select a workout first');
        return;
    }
    
    // Open the modal to add details
    document.getElementById('workoutRating').value = '3'; // Default to moderate
    document.getElementById('workoutNotes').value = 'Manually marked as completed';
    openCompletionModal();
}

// Event Listeners
startBtn.addEventListener('click', startWorkout);
stopBtn.addEventListener('click', stopWorkout);
resetBtn.addEventListener('click', resetWorkout);
settingsBtn.addEventListener('click', toggleSettingsPanel);
saveSettingsBtn.addEventListener('click', saveSettings);
closeModalBtn.addEventListener('click', closeCompletionModal);
saveWorkoutBtn.addEventListener('click', saveCompletedWorkout);
document.getElementById('markCompletedBtn').addEventListener('click', markWorkoutAsCompleted);

// Add CSS for confetti
const confettiStyle = document.createElement('style');
confettiStyle.textContent = `
    .confetti-particle {
        position: fixed;
        pointer-events: none;
        border-radius: 50%;
        animation-timing-function: cubic-bezier(0, 1, 0.5, 1);
    }
    
    .achievement-notification {
        background: linear-gradient(90deg, #4361ee, #3a0ca3) !important;
        font-weight: bold !important;
    }
`;
document.head.appendChild(confettiStyle);

// Ensure all timers and sounds are cleared
function clearAllTimers() {
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
    
    // Also clear any active sounds
    stopAllSounds();
}

// Check if a week is completed
function isWeekCompleted(weekIndex) {
    const week = c25kProgram[weekIndex];
    if (!week) return false;
    
    for (let i = 0; i < week.workouts.length; i++) {
        if (!isWorkoutCompleted(weekIndex, i)) {
            return false;
        }
    }
    return true;
}

// Check if the entire program is completed
function isProgramCompleted() {
    for (let weekIndex = 0; weekIndex < c25kProgram.length; weekIndex++) {
        if (!isWeekCompleted(weekIndex)) {
            return false;
        }
    }
    return true;
}

// Check for consistency in workout completion
function checkConsistency(days) {
    if (completedWorkouts.length < days) return false;
    
    // Sort workouts by date
    const sortedWorkouts = [...completedWorkouts].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Get the latest days workouts
    const recentWorkouts = sortedWorkouts.slice(0, days);
    
    // Check if they were done on consecutive days
    for (let i = 0; i < recentWorkouts.length - 1; i++) {
        const currentDate = new Date(recentWorkouts[i].date);
        const nextDate = new Date(recentWorkouts[i + 1].date);
        
        // Calculate difference in days
        const diffTime = Math.abs(currentDate - nextDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays !== 1) {
            return false;
        }
    }
    
    return true;
}

// Check and award achievements with enhanced effects
function checkAchievements(newWorkout = null) {
    let newAchievements = false;
    let newlyEarnedAchievements = [];
    
    availableAchievements.forEach(achievement => {
        // Skip if already earned
        if (earnedAchievements.some(a => a.id === achievement.id)) {
            return;
        }
        
        // Check if achievement condition is met
        if (achievement.checkCondition(newWorkout)) {
            // Award achievement
            const earned = {
                ...achievement,
                dateEarned: new Date().toISOString()
            };
            
            earnedAchievements.push(earned);
            newAchievements = true;
            newlyEarnedAchievements.push(earned);
        }
    });
    
    if (newAchievements) {
        saveAchievements();
        updateAchievementsDisplay();
        
        // Show notifications with delay between multiple achievements
        if (newlyEarnedAchievements.length > 0) {
            // Show first achievement immediately
            showAchievementNotification(newlyEarnedAchievements[0]);
            
            // Queue up additional achievements if there are multiple
            if (newlyEarnedAchievements.length > 1) {
                let currentIndex = 1;
                
                // Set up achievement modal close handler to show next achievement
                const showNextAchievement = () => {
                    if (currentIndex < newlyEarnedAchievements.length) {
                        showAchievementNotification(newlyEarnedAchievements[currentIndex]);
                        currentIndex++;
                    } else {
                        // When all achievements are shown, switch to the achievements tab
                        document.querySelector('.tab-btn[data-tab="achievements"]').click();
                        
                        // Reset the close handler
                        achievementModalClose.removeEventListener('click', showNextAchievement);
                        achievementModalClose.addEventListener('click', closeAchievementModal);
                    }
                };
                
                achievementModalClose.addEventListener('click', showNextAchievement);
            } else {
                // Only one achievement, just close the modal
                achievementModalClose.addEventListener('click', closeAchievementModal);
                
                // After closing, switch to achievements tab
                achievementModalClose.addEventListener('click', () => {
                    setTimeout(() => {
                        document.querySelector('.tab-btn[data-tab="achievements"]').click();
                    }, 300);
                }, { once: true });
            }
        }
    }
}

// Show achievement notification with enhanced visual feedback
function showAchievementNotification(achievement) {
    // Play special sound for achievement unlock
    if (settings.notifications === 'on' && audioContext) {
        playAchievementSound();
    }
    
    // Show notification
    const message = `🏆 Achievement unlocked: ${achievement.name}`;
    showNotification(message, 5000); // Show for 5 seconds instead of default 3
    
    // Show achievement modal with confetti
    showAchievementModal(achievement);
}

// Show achievement modal with confetti
function showAchievementModal(achievement) {
    // Set modal content
    achievementModalIcon.textContent = achievement.icon;
    achievementModalName.textContent = achievement.name;
    achievementModalDescription.textContent = achievement.description;
    
    // Create confetti container if it doesn't exist
    let confettiContainer = document.querySelector('.confetti-container');
    if (!confettiContainer) {
        confettiContainer = document.createElement('div');
        confettiContainer.className = 'confetti-container';
        document.body.appendChild(confettiContainer);
    } else {
        confettiContainer.innerHTML = ''; // Clear existing confetti
    }
    
    // Show modal
    achievementModal.classList.add('active');
    
    // Create confetti effect
    createModalConfetti(confettiContainer);
}

// Close achievement modal
function closeAchievementModal() {
    achievementModal.classList.remove('active');
    
    // Clean up confetti container after animation completes
    setTimeout(() => {
        const confettiContainer = document.querySelector('.confetti-container');
        if (confettiContainer) {
            confettiContainer.innerHTML = '';
        }
    }, 500);
}

// Create confetti specifically for the modal
function createModalConfetti(container) {
    const colors = ['#4361ee', '#4cc9f0', '#3a0ca3', '#f72585', '#7209b7', '#ffca28', '#ffb300', '#43a047'];
    const confettiCount = 200; // More confetti for a more spectacular effect
    
    // Create confetti elements
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-particle';
        
        // Randomize confetti appearance
        const size = Math.random() * 10 + 5; // Larger sizes for better visibility
        const type = Math.random() > 0.6 ? 'circle' : Math.random() > 0.5 ? 'triangle' : 'rect';
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        // Set confetti style based on type
        confetti.style.backgroundColor = type === 'circle' ? color : 'transparent';
        
        if (type === 'triangle') {
            confetti.style.width = '0';
            confetti.style.height = '0';
            confetti.style.borderLeft = `${size}px solid transparent`;
            confetti.style.borderRight = `${size}px solid transparent`;
            confetti.style.borderBottom = `${size * 1.5}px solid ${color}`;
            confetti.style.backgroundColor = 'transparent';
        } else if (type === 'rect') {
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size * 0.6}px`;
            confetti.style.backgroundColor = color;
        } else {
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size}px`;
            confetti.style.borderRadius = '50%';
        }
        
        // Set initial position at the center-bottom of the modal
        confetti.style.position = 'absolute';
        confetti.style.left = '50%';
        confetti.style.top = '50%';
        
        // Add to container
        container.appendChild(confetti);
        
        // Animate the confetti
        const destinationX = (Math.random() - 0.5) * window.innerWidth * 1.5;
        const destinationY = (Math.random() - 0.5) * window.innerHeight * 1.5;
        const rotation = Math.random() * 520;
        const delay = Math.random() * 4;
        
        confetti.animate([
            { 
                transform: 'translate(-50%, -50%) rotate(0deg)', 
                opacity: 1 
            },
            { 
                transform: `translate(calc(-50% + ${destinationX}px), calc(-50% + ${destinationY}px)) rotate(${rotation}deg)`, 
                opacity: 0 
            }
        ], {
            duration: 2500 + Math.random() * 3000,
            easing: 'cubic-bezier(0, .9, .57, 1)',
            delay: delay * 100,
            fill: 'forwards'
        });
    }
}

// Play achievement unlock sound
function playAchievementSound() {
    try {
        // Play a celebratory chord progression
        playBeep(523.25, 150); // C5
        setTimeout(() => playBeep(659.25, 150), 150); // E5
        setTimeout(() => playBeep(783.99, 150), 300); // G5
        setTimeout(() => playBeep(1046.50, 350), 450); // C6
        
        // Higher amplitudes for these notes
        updateAudioVisualization(true, 1.5);
        setTimeout(() => {
            updateAudioVisualization(false);
        }, 800);
    } catch (e) {
        console.error('Error playing achievement sound:', e);
    }
}

// Save achievements to local storage
function saveAchievements() {
    localStorage.setItem('c25k_achievements', JSON.stringify(earnedAchievements));
}

// Load achievements from local storage
function loadAchievements() {
    const savedAchievements = localStorage.getItem('c25k_achievements');
    if (savedAchievements) {
        earnedAchievements = JSON.parse(savedAchievements);
    }
    updateAchievementsDisplay();
}

// Update achievements display
function updateAchievementsDisplay() {
    const container = document.getElementById('achievementsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (earnedAchievements.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'empty-achievements';
        emptyMessage.textContent = 'Complete workouts to earn achievements';
        container.appendChild(emptyMessage);
        return;
    }
    
    // Show earned achievements
    earnedAchievements.forEach(achievement => {
        const achievementElement = createAchievementElement(achievement, false);
        container.appendChild(achievementElement);
    });
    
    // Show locked achievements
    availableAchievements.forEach(achievement => {
        if (!earnedAchievements.some(a => a.id === achievement.id)) {
            const achievementElement = createAchievementElement(achievement, true);
            container.appendChild(achievementElement);
        }
    });
}

// Updated create achievement element with special effects for new achievements
function createAchievementElement(achievement, locked) {
    const element = document.createElement('div');
    element.className = 'achievement-item';
    
    // Check if this is a newly earned achievement
    const isNewAchievement = achievement.dateEarned && 
        (new Date().getTime() - new Date(achievement.dateEarned).getTime() < 24 * 60 * 60 * 1000);
    
    if (locked) {
        element.classList.add('locked');
    } else if (isNewAchievement) {
        element.classList.add('new-achievement');
    }
    
    const icon = document.createElement('div');
    icon.className = 'achievement-icon';
    icon.textContent = achievement.icon;
    
    const name = document.createElement('div');
    name.className = 'achievement-name';
    name.textContent = achievement.name;
    
    const description = document.createElement('div');
    description.className = 'achievement-description';
    description.textContent = locked ? '???' : achievement.description;
    
    element.appendChild(icon);
    element.appendChild(name);
    element.appendChild(description);
    
    if (!locked && achievement.dateEarned) {
        const date = document.createElement('div');
        date.className = 'achievement-date';
        const formattedDate = new Date(achievement.dateEarned).toLocaleDateString();
        date.textContent = isNewAchievement ? `NEW! ${formattedDate}` : formattedDate;
        element.appendChild(date);
    }
    
    return element;
}

// Create confetti effect for a specific element - used for achievement items in list
function createConfetti(element) {
    const confettiCount = 100;
    const colors = ['#4361ee', '#4cc9f0', '#3a0ca3', '#f72585', '#7209b7'];
    
    // Get element position
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-particle';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 8 + 3}px`;
        confetti.style.height = `${Math.random() * 4 + 2}px`;
        confetti.style.position = 'fixed';
        confetti.style.zIndex = '1000';
        confetti.style.top = `${centerY}px`;
        confetti.style.left = `${centerX}px`;
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        
        document.body.appendChild(confetti);
        
        // Animate the confetti
        const angle = Math.random() * Math.PI * 2;
        const velocity = 2 + Math.random() * 4;
        const tx = Math.cos(angle) * velocity * (Math.random() * 80 + 20);
        const ty = Math.sin(angle) * velocity * (Math.random() * 50 + 20) - 100; // Upward bias
        
        confetti.animate([
            { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
            { transform: `translate(${tx}px, ${ty}px) rotate(${Math.random() * 720 - 360}deg)`, opacity: 0 }
        ], {
            duration: 1000 + Math.random() * 1000,
            easing: 'cubic-bezier(0.22, 0.61, 0.36, 1)',
            fill: 'forwards'
        });
        
        // Remove confetti after animation
        setTimeout(() => {
            if (document.body.contains(confetti)) {
                document.body.removeChild(confetti);
            }
        }, 2000);
    }
}

// Tab switching functionality
function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            
            // Deactivate all tabs and buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Activate the selected tab and button
            button.classList.add('active');
            
            if (tabName === 'workouts') {
                document.getElementById('workoutsTab').classList.add('active');
            } else if (tabName === 'achievements') {
                document.getElementById('achievementsTab').classList.add('active');
            }
        });
    });
}

// Add event listener for achievement modal close button
document.addEventListener('DOMContentLoaded', function() {
    if (achievementModalClose) {
        achievementModalClose.addEventListener('click', closeAchievementModal);
    }
});

// Initialize app
function initApp() {
    generateWorkoutSelectors();
    applySettings();
    createAudioVisualization();
    loadAchievements();
    setupTabs();
    
    // Check for any new achievements based on existing data
    setTimeout(() => checkAchievements(), 1000);
    
    // Clear any lingering timers on page load
    clearAllTimers();
}

// Run initialization
initApp();

// Ensure all timers and sounds are cleared